# Driveway Motion-Triggered Image Capture
- id: driveway_image_capture
  alias: Driveway Video Capture
  description: >-
    Capture video when both person and pet motion detected in driveway within 30
    seconds, OR when person detected during active walk
  triggers:
    - entity_id: binary_sensor.driveway_person
      to: "on"
      id: person_motion
      trigger: state
    - entity_id: binary_sensor.driveway_pet
      to: "on"
      id: pet_motion
      trigger: state
  conditions:
    - condition: time
      after: "06:00:00"
      before: "22:00:00"
    - condition: template
      value_template: |
        {{ states('input_text.driveway_camera_entity') not in ['unknown', ''] }}
  actions:
    - choose:
        - conditions:
            - condition: trigger
              id: person_motion
            - condition: state
              state: "off"
              entity_id: binary_sensor.driveway_pet
          sequence:
            - wait_for_trigger:
                - entity_id: binary_sensor.driveway_pet
                  to: "on"
                  trigger: state
              timeout:
                hours: 0
                minutes: 0
                seconds: 15
                milliseconds: 0
              continue_on_timeout: false
        - conditions:
            - condition: trigger
              id: pet_motion
            - condition: state
              state: "off"
              entity_id: binary_sensor.driveway_person
          sequence:
            - wait_for_trigger:
                - entity_id: binary_sensor.driveway_person
                  to: "on"
                  trigger: state
              timeout:
                hours: 0
                minutes: 0
                seconds: 15
                milliseconds: 0
              continue_on_timeout: false
    - target:
        entity_id: input_datetime.last_walk_detection
      data:
        datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      action: input_datetime.set_datetime
    - target:
        entity_id: input_boolean.driveway_video_ready
      action: input_boolean.turn_off
      data: {}
    - action: shell_command.ensure_backup_directories
      continue_on_error: true
    - action: shell_command.backup_driveway_walk_video
      continue_on_error: true
    - delay: "00:00:02"
    - target:
        entity_id: "{{ states('input_text.driveway_camera_entity') }}"
      data:
        duration: 30
        filename: /config/www/local/ai_image_notifications/driveway_dogwalk_capture.mp4
        lookback: 15
      action: camera.record
    - delay: "00:00:32"
    - target:
        entity_id: input_boolean.driveway_video_ready
      action: input_boolean.turn_on
      data: {}
  mode: single
 
# Family Room AI Analysis Automation
- id: trigger_family_room_analysis
  alias: "Trigger Family Room AI Analysis"
  description: "Analyze family room tidiness when person motion detected"
  trigger:
    # Trigger when person motion turns on (person enters family room)
    - platform: state
      entity_id: binary_sensor.family_room_person_motion
      to: "on"
    # Trigger when person motion turns off (person leaves family room)
    - platform: state
      entity_id: binary_sensor.family_room_person_motion
      to: "off" 
      for:
        minutes: 2  # Wait 2 minutes after person leaves to analyze
    # Manual trigger via force check button
    - platform: state
      entity_id: input_boolean.force_family_room_check
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.ai_detection_enabled
      state: "on"
    - condition: state
      entity_id: input_boolean.family_room_monitoring_enabled
      state: "on"
    # Only analyze if camera entity is configured
    - condition: template
      value_template: >
        {{ states('input_text.family_room_camera_entity') not in ['unknown', ''] }}
    # Check if analysis is needed (based on time since last check or force check)
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.force_family_room_check
          state: "on"
        - condition: template
          value_template: >
            {% set last_check = states('input_datetime.family_room_last_check') %}
            {% if last_check == 'unknown' %}
              true
            {% else %}
              {{ (as_timestamp(now()) - as_timestamp(last_check)) > 300 }}
            {% endif %}
  action:
    # Update last check time
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.family_room_last_check
      data:
        datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
    
    # Take camera snapshot and call AI Tasks to analyze family room
    - service: camera.snapshot
      target:
        entity_id: "{{ states('input_text.family_room_camera_entity') }}"
      data:
        filename: "/config/www/local/family_room_snapshot.jpg"
    
    - service: ai_task.generate_data
      data:
        task_name: "family_room_tidiness_analysis"
        instructions: >
          Analyze this family room/living room. Focus ONLY on practical safety and cleanliness.
          Rate tidiness 0-100. If below {{ states('input_number.family_room_cleanliness_threshold') }}, 
          respond "needs_tidying" and list issues. If above, respond "tidy".
          
          ONLY flag these issues:
          - Food/drinks left out (especially if sticky/messy)
          - Dishes with food residue  
          - Items on the floor (tripping hazard)
          - Spills that need cleaning
          
          IGNORE: blankets on chairs, remotes on tables, books/papers, decorative items, stuffed animals on furniture, charging cables
        attachments:
          - media_content_id: media-source://media_source/local/family_room_snapshot.jpg
            media_content_type: image/jpeg
        entity_id: ai_task.google_ai_task
      response_variable: family_room_ai_response
    
    # Store the main result - extract status from response
    - service: input_text.set_value
      target:
        entity_id: input_text.family_room_analysis_result
      data:
        value: >
          {% set response = family_room_ai_response.data | lower %}
          {% if 'needs_tidying' in response %}
            needs_tidying
          {% elif 'tidy' in response %}
            tidy  
          {% else %}
            unknown
          {% endif %}
    
    # Get specific tasks
    - service: ai_task.generate_data
      data:
        task_name: "family_room_specific_tasks"
        instructions: >
          Look at this family room. Create a brief, family-friendly list of important tasks only:
          
          üçΩÔ∏è DISHES: [plates, cups with food/drink to kitchen]
          üßΩ SPILLS: [sticky spots to wipe up]
          üö∂ FLOOR: [things on floor that could be tripped on]
          
          Keep it simple for kids to understand. Skip categories with no real issues.
          IGNORE: blankets, remotes, books, decorative items, toys on furniture.
          Example: "üçΩÔ∏è DISHES: cup with milk to kitchen"
        attachments:
          - media_content_id: media-source://media_source/local/family_room_snapshot.jpg
            media_content_type: image/jpeg
        entity_id: ai_task.google_ai_task
      response_variable: family_room_tasks_response
    
    # Store specific tasks
    - service: input_text.set_value
      target:
        entity_id: input_text.family_room_specific_tasks
      data:
        value: "{{ family_room_tasks_response.data | truncate(200) }}"
    
    # Turn off force check trigger  
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.force_family_room_check


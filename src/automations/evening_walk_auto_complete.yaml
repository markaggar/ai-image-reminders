# Mark evening walk as done when person detected with dog at driveway
- id: evening_walk_auto_complete
  alias: "Evening Walk Auto Complete"
  description: "Automatically mark evening walk as complete when detected (3pm-10pm)"
  trigger:
    - platform: state
      entity_id: sensor.driveway_analysis
      to: "ending_dog_walk"
  condition:
    - condition: time
      after: "15:00:00"
      before: "22:00:00"
    - condition: state
      entity_id: input_boolean.dog_walk_monitoring_enabled
      state: "on"
    # Check if evening walk not already done today
    - condition: template
      value_template: >
        {% set evening_walk = states('input_datetime.evening_walk_done') %}
        {% set today = now().strftime('%Y-%m-%d') %}
        {{ evening_walk == 'unknown' or evening_walk[:10] != today }}
  action:
    # Clear walk in progress flag
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.walk_in_progress
    
    # Mark evening walk as done
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.evening_walk_done
      data:
        datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
    
    # Clear evening walk notification for Liam
    - event: UNotify
      event_data_template:
        message: "clear_notification"
        message_target: liam
        tag: evening_dog_walk
    
    # Clear walk started notification
    - event: UNotify
      event_data_template:
        message: "clear_notification"
        message_target: liam
        tag: walk_started
    
    # Send encouraging acknowledgment to Liam
    - event: UNotify
      event_data_template:
        message_speak: 'Excellent job taking the dog for an evening walk! You''re amazing!'
        message_display: 'Evening Walk Complete! 🎉'
        message: >
          Great job taking the dog for their evening walk! You''re amazing! 
          {% set start_time = states('input_datetime.current_walk_started') %}
          {% if start_time != 'unknown' %}
            {% set duration = ((as_timestamp(now()) - as_timestamp(start_time)) / 60) | round(0) %}
            Walk duration: {{ duration }} minutes.
          {% endif %} 🐕❤️
        priority: normal
        channel: General
        aiprompt: 'no'
        message_target: liam
        tag: evening_walk_complete
    
    # Send completion status to parents
    - event: UNotify
      event_data_template:
        message_speak: 'no'
        message_display: 'no'
        message: >
          Evening walk completed at {{ now().strftime('%H:%M') }}.
          {% set start_time = states('input_datetime.current_walk_started') %}
          {% if start_time != 'unknown' %}
            {% set duration = ((as_timestamp(now()) - as_timestamp(start_time)) / 60) | round(0) %}
            Duration: {{ duration }} minutes.
          {% endif %}
        priority: low
        channel: General
        aiprompt: 'no'
        message_target: parents
        tag: evening_walk_status


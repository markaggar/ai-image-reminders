# Driveway AI Analysis Automation
- id: driveway_ai_analysis
  alias: "Driveway AI Analysis"
  description: "Analyze driveway images when both person and pet images are ready"
  trigger:
    - platform: state
      entity_id: 
        - input_boolean.person_images_ready
        - input_boolean.pet_images_ready
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.ai_detection_enabled
      state: "on"
    - condition: state
      entity_id: input_boolean.dog_walk_monitoring_enabled
      state: "on"
    # Both image sets must be ready
    - condition: state
      entity_id: input_boolean.person_images_ready
      state: "on"
    - condition: state
      entity_id: input_boolean.pet_images_ready
      state: "on"
    # Only analyze if camera entity is configured
    - condition: template
      value_template: >
        {{ states('input_text.driveway_camera_entity') not in ['unknown', ''] }}
  action:
    # Update last detection time
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.last_walk_detection
      data:
        datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
    
    # Analyze all 6 images with AI Tasks
    - service: ai_task.generate_data
      data:
        task_name: "driveway_person_dog_detection"
        instructions: >
          Analyze these driveway images captured from person motion (first 3) and pet motion (last 3). Look for:
          1. A person walking with a dog
          2. Person and dog together in the scene
          3. Dog walking activity (leash, person + dog movement)
          
          If you see a person with a dog facing away from the camera or walking down the steps (that appears to be leaving), respond "starting_dog_walk".
          If you see a person with a dog facing toward the camera or walking up the steps (that appears to be arriving), respond "ending_dog_walk".
          If you see only a person, respond "person_only".
          If you see only a dog, respond "dog_only".
          If you see neither or just empty driveway, respond "empty".
          
          Some of the images may not have anyone or any animal in the scene. Ignore those except for using the timestamp in the upper right corner to infer direction of travel.

          Focus on detecting dog walking activity specifically and whether the walk is just starting or ending.
        attachments:
          - media_content_id: media-source://media_source/local/driveway_person_1.jpg
            media_content_type: image/jpeg
          - media_content_id: media-source://media_source/local/driveway_person_2.jpg
            media_content_type: image/jpeg
          - media_content_id: media-source://media_source/local/driveway_person_3.jpg
            media_content_type: image/jpeg
          - media_content_id: media-source://media_source/local/driveway_pet_1.jpg
            media_content_type: image/jpeg
          - media_content_id: media-source://media_source/local/driveway_pet_2.jpg
            media_content_type: image/jpeg
          - media_content_id: media-source://media_source/local/driveway_pet_3.jpg
            media_content_type: image/jpeg
        entity_id: ai_task.google_ai_task
      response_variable: driveway_ai_response
    
    # Store the driveway analysis result (extract only the first line)
    - service: input_text.set_value
      target:
        entity_id: input_text.driveway_analysis_result
      data:
        value: "{{ (driveway_ai_response.data | lower).split('\n')[0].strip() }}"
    
    # Reset both image ready flags for next cycle
    - service: input_boolean.turn_off
      target:
        entity_id: 
          - input_boolean.person_images_ready
          - input_boolean.pet_images_ready


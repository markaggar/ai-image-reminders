# Dog Walking Monitoring Automations
# Track dog walks and send reminders based on morning/evening schedule

# Process dog walk detection results - update walk completion times
- id: process_dog_walk_detection
    alias: "Process Dog Walk Detection"
    description: "Process AI detection results to update walk completion status"
    trigger:
      - platform: state
        entity_id: sensor.dog_walk_detection
        to: 
          - "leaving"
          - "arriving"
    condition:
      - condition: state
        entity_id: input_boolean.dog_walk_monitoring_enabled
        state: "on"
      - condition: template
        value_template: "{{ state_attr('sensor.dog_walk_detection', 'person_and_dog_detected') == true }}"
      - condition: template
        value_template: "{{ state_attr('sensor.dog_walk_detection', 'confidence') | int >= 6 }}"
    action:
      - choose:
          # Dog walk started (leaving)
          - conditions:
              - condition: state
                entity_id: sensor.dog_walk_detection
                state: "leaving"
            sequence:
              - service: notify.parents
                data:
                  title: "Dog Walk Started"
                  message: "Great! Dog walk has started."
                  data:
                    image: /media/local/driveway_sequence_3.jpg
                    tag: dog_walk_started
                    group: house_monitoring
              
              - event: UNotify
                event_data:
                  message: "Have a great walk with the dog!"
                  message_speak: "yes"
                  message_display: "yes"
                  tag: dog_walk_started
          
          # Dog walk completed (arriving)
          - conditions:
              - condition: state
                entity_id: sensor.dog_walk_detection
                state: "arriving"
            sequence:
              - service: input_datetime.set_datetime
                entity_id: input_datetime.last_walk_detection
                data:
                  datetime: "{{ now() }}"
              
              - service: notify.parents
                data:
                  title: "Dog Walk Completed! üêï"
                  message: >
                    Walk completed at {{ now().strftime('%I:%M %p') }}! 
                    Thank you for taking care of our furry friend.
                  data:
                    image: /media/local/driveway_sequence_3.jpg
                    tag: dog_walk_completed
                    group: house_monitoring
              
              - event: UNotify
                event_data:
                  message: "Welcome back from the dog walk!"
                  message_speak: "yes"
                  message_display: "yes"
                  tag: dog_walk_completed
              
              # Determine if this satisfies morning or evening walk
              - choose:
                  - conditions:
                      - condition: time
                        after: "05:00:00"
                        before: "12:00:00"
                    sequence:
                      - service: input_datetime.set_datetime
                        entity_id: input_datetime.morning_walk_done
                        data:
                          datetime: "{{ now() }}"
                  - conditions:
                      - condition: time
                        after: "16:00:00"
                        before: "23:59:59"
                    sequence:
                      - service: input_datetime.set_datetime
                        entity_id: input_datetime.evening_walk_done
                        data:
                          datetime: "{{ now() }}"

# Morning dog walk reminder system
- id: morning_dog_walk_reminder
    alias: "Morning Dog Walk Reminder"
    description: "Send morning dog walk reminders if not completed"
    trigger:
      - platform: time
        at: "08:00:00"  # First reminder at 8 AM
      - platform: time
        at: "08:30:00"  # Escalation at 8:30 AM
      - platform: time
        at: "09:00:00"  # Final morning reminder at 9 AM
    condition:
      - condition: state
        entity_id: input_boolean.dog_walk_reminders_enabled
        state: "on"
      - condition: template
        value_template: >
          {% set morning_walk = states('input_datetime.morning_walk_done') %}
          {% set today = now().strftime('%Y-%m-%d') %}
          {{ morning_walk == 'unknown' or not morning_walk.startswith(today) }}
      - condition: state
        entity_id: input_boolean.quiet_hours_active
        state: "off"
    action:
      - service: notify.parents
        data:
          title: >
            {% set hour = now().hour %}
            {% if hour == 8 %}
              Morning Dog Walk Reminder üåÖ
            {% elif hour == 8 and now().minute >= 30 %}
              Dog Walk Still Needed üêï
            {% else %}
              Final Morning Reminder üö®
            {% endif %}
          message: >
            {% set hour = now().hour %}
            {% set minute = now().minute %}
            {% if hour == 8 and minute == 0 %}
              Good morning! Time for the dog's morning walk.
            {% elif hour == 8 and minute == 30 %}
              The dog is still waiting for her morning walk. She's probably getting restless!
            {% else %}
              This is the final morning reminder - please take the dog out before it gets too late.
            {% endif %}
          data:
            tag: "morning_dog_walk"
            group: "dog_reminders"
            actions:
              - action: "dog_walk_completed"
                title: "Just Finished Walk"
              - action: "snooze_dog_reminder"
                title: "Snooze 30min"

# Evening dog walk reminder system
- id: evening_dog_walk_reminder
    alias: "Evening Dog Walk Reminder"
    description: "Send evening dog walk reminders if not completed"
    trigger:
      - platform: time
        at: "17:00:00"  # First reminder at 5 PM
      - platform: time
        at: "18:00:00"  # Second reminder at 6 PM
      - platform: time
        at: "19:00:00"  # Final evening reminder at 7 PM
    condition:
      - condition: state
        entity_id: input_boolean.dog_walk_reminders_enabled
        state: "on"
      - condition: template
        value_template: >
          {% set evening_walk = states('input_datetime.evening_walk_done') %}
          {% set today = now().strftime('%Y-%m-%d') %}
          {{ evening_walk == 'unknown' or not evening_walk.startswith(today) }}
      - condition: state
        entity_id: input_boolean.quiet_hours_active
        state: "off"
    action:
      - service: notify.parents
        data:
          title: >
            {% set hour = now().hour %}
            {% if hour == 17 %}
              Evening Dog Walk Reminder üåÖ
            {% elif hour == 18 %}
              Dog Walk Still Needed üêï
            {% else %}
              Final Evening Reminder üö®
            {% endif %}
          message: >
            {% set hour = now().hour %}
            {% if hour == 17 %}
              Time for the dog's evening walk! She's been waiting patiently.
            {% elif hour == 18 %}
              The dog still needs her evening walk. She's probably at the door waiting!
            {% else %}
              Final reminder - please take the dog out before bedtime.
            {% endif %}
          data:
            tag: "evening_dog_walk"
            group: "dog_reminders"
            actions:
              - action: "dog_walk_completed"
                title: "Just Finished Walk"
              - action: "snooze_dog_reminder"
                title: "Snooze 30min"

# Handle dog walk notification actions
- id: handle_dog_walk_actions
    alias: "Handle Dog Walk Notification Actions"
    description: "Process dog walk notification responses"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "dog_walk_completed"
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "snooze_dog_reminder"
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'dog_walk_completed' }}"
            sequence:
              - service: input_datetime.set_datetime
                entity_id: input_datetime.last_walk_detection
                data:
                  datetime: "{{ now() }}"
              
              # Determine if this is morning or evening
              - choose:
                  - conditions:
                      - condition: time
                        after: "05:00:00"
                        before: "12:00:00"
                    sequence:
                      - service: input_datetime.set_datetime
                        entity_id: input_datetime.morning_walk_done
                        data:
                          datetime: "{{ now() }}"
                  - conditions:
                      - condition: time
                        after: "16:00:00"
                        before: "23:59:59"
                    sequence:
                      - service: input_datetime.set_datetime
                        entity_id: input_datetime.evening_walk_done
                        data:
                          datetime: "{{ now() }}"
              
              - service: notify.parents
                data:
                  title: "Walk Logged! üêï‚úÖ"
                  message: "Thanks for updating! Walk has been recorded."
          
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'snooze_dog_reminder' }}"
            sequence:
              - service: input_boolean.turn_on
                entity_id: input_boolean.dog_reminder_snoozed
              
              - delay:
                  minutes: 30
              
              - service: input_boolean.turn_off
                entity_id: input_boolean.dog_reminder_snoozed
